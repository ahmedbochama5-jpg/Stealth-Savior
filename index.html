<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø®ÙÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ù…Ø­Ø³Ù†Ø©)</title>

    <!-- three.js r128 CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/controls/OrbitControls.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        body{background:linear-gradient(135deg,#0c1426,#1a1a2e,#16213e);color:#fff;min-height:100vh;overflow:hidden}
        .container{display:flex;flex-direction:column;height:100vh}
        header{text-align:center;padding:20px;background:rgba(0,0,0,0.8);border-bottom:3px solid #06d6a0}
        h1{font-size:2.2rem;margin-bottom:8px;background:linear-gradient(45deg,#06d6a0,#9d4edd,#ffd166);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
        .subtitle{font-size:1rem;color:#ccc}
        .game-container{display:flex;flex:1;position:relative}
        #game3d{flex:1;background:#000}
        .ui-overlay{position:absolute;inset:0;pointer-events:none;z-index:100}
        .stats-panel{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.7);padding:16px;border-radius:12px;border:2px solid #06d6a0;min-width:200px}
        .stat{display:flex;justify-content:space-between;margin-bottom:10px;font-size:1rem}
        .stat-value{color:#ffd166;font-weight:700}
        .controls-panel{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.7);padding:12px;border-radius:12px;border:2px solid #9d4edd;display:flex;gap:10px;pointer-events:auto}
        .btn{background:linear-gradient(145deg,#9d4edd,#7b2cbf);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:700;transition:all .2s}
        .btn:hover{transform:translateY(-2px)}
        .camera-alert{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(239,71,111,0.9);padding:14px 28px;border-radius:10px;font-size:1.2rem;font-weight:700;animation:pulse 1s infinite;display:none;pointer-events:none}
        @keyframes pulse{0%{transform:translate(-50%,-50%) scale(1);opacity:1}50%{transform:translate(-50%,-50%) scale(1.05);opacity:.85}100%{transform:translate(-50%,-50%) scale(1);opacity:1}}
        .instructions{position:absolute;top:20px;right:20px;background:rgba(0,0,0,0.7);padding:14px;border-radius:12px;border:2px solid #ffd166;max-width:300px}
        .instructions h3{color:#ffd166;margin-bottom:10px}
        .instructions ul{list-style:none;line-height:1.6}
        .instructions li{margin-bottom:6px;display:flex;align-items:center}
        .instructions li::before{content:"â€¢";color:#06d6a0;font-weight:700;margin-left:8px}
        .minimap{position:absolute;bottom:20px;right:20px;width:150px;height:150px;background:rgba(0,0,0,0.7);border:2px solid #118ab2;border-radius:10px;overflow:hidden}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ø§Ù„Ù…Ù†Ù‚Ø° Ø§Ù„Ø®ÙÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ (Ù…Ø­Ø³Ù†Ø©)</h1>
            <p class="subtitle">ØªØ¬Ø±Ø¨Ø© Ù„Ø¹Ø¨ ØºØ§Ù…Ø±Ø© â€” Ø§Ù„Ø¢Ù† Ù…Ø¹ ØªØ­Ø±Ù‘ÙÙƒ Ø³Ù„Ø³ ÙˆØ¥ØµÙ„Ø§Ø­Ø§Øª</p>
        </header>

        <div class="game-container">
            <div id="game3d"></div>

            <div class="ui-overlay">
                <div class="stats-panel">
                    <div class="stat"><span>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span><span class="stat-value" id="level">1</span></div>
                    <div class="stat"><span>Ø§Ù„Ø±Ù‡Ø§Ø¦Ù† Ø§Ù„Ù…Ù†Ù‚Ø°ÙŠÙ†:</span><span class="stat-value" id="rescued">0/3</span></div>
                    <div class="stat"><span>Ø§Ù„Ø­Ø§Ù„Ø©:</span><span class="stat-value" id="status">Ø¢Ù…Ù†</span></div>
                    <div class="stat"><span>Ø§Ù„Ù‚Ø¯Ø±Ø§Øª:</span><span class="stat-value" id="abilities">3/3</span></div>
                </div>

                <div class="controls-panel">
                    <button class="btn" id="smokeBtn">Ù‚Ù†Ø¨Ù„Ø© Ø¯Ø®Ø§Ù† (Q)</button>
                    <button class="btn" id="hackBtn">Ø§Ø®ØªØ±Ø§Ù‚ ÙƒØ§Ù…ÙŠØ±Ø§ (H)</button>
                    <button class="btn" id="visionBtn">Ø±Ø¤ÙŠØ© Ù„ÙŠÙ„ÙŠØ© (N)</button>
                    <button class="btn" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (R)</button>
                </div>

                <div class="camera-alert" id="cameraAlert">âš ï¸ Ù„Ù‚Ø¯ Ø±ØµØ¯ØªÙƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§!</div>

                <div class="instructions">
                    <h3>ğŸ® ÙƒÙŠÙÙŠØ© Ø§Ù„Ù„Ø¹Ø¨:</h3>
                    <ul>
                        <li>Ø§Ø³ØªØ®Ø¯Ù… WASD Ù„Ù„Ø­Ø±ÙƒØ© (Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø¨Ø§Ù„Ø­Ø±ÙƒØ©)</li>
                        <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø§ÙˆØ³ Ù„Ù„Ù†Ø¸Ø± Ø­ÙˆÙ„Ùƒ</li>
                        <li>Ø£Ù†Ù‚Ø° Ø§Ù„Ø±Ù‡Ø§Ø¦Ù† (Ø§Ù„Ù…ÙƒØ¹Ø¨Ø§Øª Ø§Ù„Ø²Ø±Ù‚Ø§Ø¡)</li>
                        <li>ØªØ¬Ù†Ø¨ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª (Ø§Ù„Ø£Ø¶ÙˆØ§Ø¡ Ø§Ù„Ø­Ù…Ø±Ø§Ø¡)</li>
                        <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø®Ø§Ø¨Ø¦ (Ø§Ù„Ù…ÙƒØ¹Ø¨Ø§Øª Ø§Ù„Ø¯Ø§ÙƒÙ†Ø©)</li>
                        <li>Ø§Ø®ØªØ±Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ù„ØªØ¹Ø·ÙŠÙ„Ù‡Ø§</li>
                    </ul>
                </div>

                <div class="minimap" id="minimap"></div>
            </div>
        </div>
    </div>

<script>
/* ===== Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ§Ù„Ø­Ø§Ù„Ø© ===== */
let scene, camera, renderer, controls;
let player, guards = [], hostages = [], cameras = [], walls = [];
let lastPlayerPosition = new THREE.Vector3(); // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø±ÙƒØ©
let keysPressed = {}; // Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©

const gameState = {
    level: 1,
    rescued: 0,
    totalHostages: 3,
    abilities: 3,
    maxAbilities: 3,
    status: 'Ø¢Ù…Ù†',
    cameraAlert: false
};

/* ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø´Ù‡Ø¯ ===== */
function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0c1426);
    scene.fog = new THREE.Fog(0x0c1426, 10, 50);

    camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 10);

    renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    // Ø®ÙØ¶ Ø­Ø¬Ù… Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø¸Ù„ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„Ø£Ø¯Ø§Ø¡
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    document.getElementById('game3d').appendChild(renderer.domElement);

    controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.minDistance = 3;
    controls.maxDistance = 30;

    // Ø¥Ø¶Ø§Ø¡Ø§Øª
    const ambientLight = new THREE.AmbientLight(0x404040, 0.5);
    scene.add(ambientLight);

    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
    directionalLight.position.set(10, 20, 10);
    directionalLight.castShadow = true;
    directionalLight.shadow.mapSize.width = 1024;
    directionalLight.shadow.mapSize.height = 1024;
    scene.add(directionalLight);

    // Ø£Ø±Ø¶ÙŠØ© ÙˆØ´Ø¨ÙƒØ© Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
    const floorGeometry = new THREE.PlaneGeometry(60, 60);
    const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x2d3748, roughness: 0.9, metalness: 0.1 });
    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    const gridHelper = new THREE.GridHelper(50, 50, 0x4a5568, 0x4a5568);
    scene.add(gridHelper);

    // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ¦Ø©
    createPlayer();
    createEnvironment();
    createGuards();
    createCameras();
    createHostages();

    setupEventListeners();
    updateUI();

    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ
    lastPlayerPosition.copy(player.position);

    // Ø¨Ø¯Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø©
    clock.start();
    animate();
}

/* ===== Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙˆØ§Ù„Ø¨ÙŠØ¦Ø© ===== */
function createPlayer() {
    const geometry = new THREE.CapsuleGeometry(0.5, 1, 4, 8);
    const material = new THREE.MeshStandardMaterial({ color: 0x06d6a0 });
    player = new THREE.Mesh(geometry, material);
    player.position.set(0, 0.5, 0);
    player.castShadow = true;
    scene.add(player);
}

function createEnvironment() {
    const wallGeometry = new THREE.BoxGeometry(1, 2, 1);
    const wallMaterial = new THREE.MeshStandardMaterial({ color: 0x4a5568 });

    const wallPositions = [
        {x:5,z:0},{x:5,z:1},{x:5,z:2},{x:5,z:3},
        {x:-5,z:0},{x:-5,z:-1},{x:-5,z:-2},
        {x:0,z:5},{x:1,z:5},{x:2,z:5},
        {x:-3,z:-5},{x:-2,z:-5},{x:-1,z:-5},
        {x:8,z:8},{x:8,z:7},{x:8,z:6},
        {x:-8,z:8},{x:-7,z:8},{x:-6,z:8}
    ];

    wallPositions.forEach(pos => {
        const wall = new THREE.Mesh(wallGeometry, wallMaterial);
        wall.position.set(pos.x, 1, pos.z);
        wall.castShadow = true;
        wall.receiveShadow = true;
        walls.push(wall);
        scene.add(wall);
    });

    const hideoutGeometry = new THREE.BoxGeometry(2,1,2);
    const hideoutMaterial = new THREE.MeshStandardMaterial({ color: 0x1a202c });
    const hideoutPositions = [{x:3,z:3},{x:-3,z:3},{x:3,z:-3},{x:-3,z:-3}];
    hideoutPositions.forEach(pos => {
        const hideout = new THREE.Mesh(hideoutGeometry, hideoutMaterial);
        hideout.position.set(pos.x,0.5,pos.z);
        hideout.receiveShadow = true;
        scene.add(hideout);
    });
}

/* ===== Ø§Ù„Ø­Ø±Ø§Ø³ ===== */
function createGuards() {
    const geometry = new THREE.CapsuleGeometry(0.5,1,4,8);
    const material = new THREE.MeshStandardMaterial({ color: 0xef476f });
    const guardPositions = [
        {x:8,z:0,patrol:[{x:8,z:0},{x:8,z:4},{x:4,z:4}]},
        {x:-8,z:0,patrol:[{x:-8,z:0},{x:-8,z:-4},{x:-4,z:-4}]}
    ];
    guardPositions.forEach(pos=>{
        const guard = new THREE.Mesh(geometry, material.clone());
        guard.position.set(pos.x,0.5,pos.z);
        guard.castShadow = true;
        guard.userData = { patrolPoints: pos.patrol, currentPatrolIndex:0, alert:false, target:null, speed:0.02 };
        guards.push(guard);
        scene.add(guard);
    });
}

/* ===== Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª (Ù…Ø¹ Ø¥ØµÙ„Ø§Ø­ target) ===== */
function createCameras() {
    const cameraGeometry = new THREE.CylinderGeometry(0.3,0.3,0.5,8);
    const cameraMaterial = new THREE.MeshStandardMaterial({ color: 0xff9800 });

    const cameraPositions = [
        {x:10,z:10,direction:new THREE.Vector3(-1,0,-1)},
        {x:-10,z:10,direction:new THREE.Vector3(1,0,-1)},
        {x:0,z:-10,direction:new THREE.Vector3(0,0,1)}
    ];

    cameraPositions.forEach(pos=>{
        const cameraObj = new THREE.Mesh(cameraGeometry, cameraMaterial.clone());
        cameraObj.position.set(pos.x,2,pos.z);
        cameraObj.castShadow = true;

        // Ø¶ÙˆØ¡ Ø³Ø¨ÙˆØª ÙŠÙ…Ø«Ù„ Ø±Ø¤ÙŠØ© Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const cameraLight = new THREE.SpotLight(0xff4444, 2, 12, Math.PI/6, 0.5);
        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø¶ÙˆØ¡ ÙƒØ·ÙÙ„ Ù„Ø¬Ø³Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„ÙŠÙƒÙˆÙ† ØªØ­Ø±ÙŠÙƒÙ‡ Ù…Ø±ØªØ¨Ø·Ø§Ù‹ Ø¨Ù‡Ø§
        cameraLight.position.set(0, -0.2, 0);
        cameraObj.add(cameraLight);

        // Ù†Ø­Ø¯Ø¯ target ÙÙŠ Ù…ÙˆÙ‚Ø¹ Ø£Ù…Ø§Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ (Ø§ØªØ¬Ø§Ù‡ Ù…ÙØ¶Ø¨ÙˆÙØ· ÙƒÙ…ÙˆØ¶Ø¹)
        const targetPos = cameraObj.position.clone().add(pos.direction.clone().normalize().multiplyScalar(6));
        cameraLight.target.position.copy(targetPos);
        scene.add(cameraLight.target); // ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ù„Ù…Ø´Ù‡Ø¯

        cameraObj.userData = { active:false, hacked:false, direction: pos.direction.clone().normalize(), light: cameraLight, blinded:false };
        cameras.push(cameraObj);
        scene.add(cameraObj);
    });
}

/* ===== Ø§Ù„Ø±Ù‡Ø§Ø¦Ù† ===== */
function createHostages() {
    const geometry = new THREE.BoxGeometry(0.8,0.8,0.8);
    const material = new THREE.MeshStandardMaterial({ color: 0x118ab2 });
    const hostagePositions = [{x:7,z:7},{x:-7,z:7},{x:7,z:-7}];
    hostagePositions.forEach(pos=>{
        const hostage = new THREE.Mesh(geometry, material.clone());
        hostage.position.set(pos.x,0.4,pos.z);
        hostage.castShadow = true;
        hostage.userData = { rescued:false };
        hostages.push(hostage);
        scene.add(hostage);
    });
}

/* ===== Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙˆÙ† ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ù„ ===== */
function setupEventListeners(){
    window.addEventListener('resize', onWindowResize);
    document.getElementById('smokeBtn').addEventListener('click', useSmokeGrenade);
    document.getElementById('hackBtn').addEventListener('click', hackCamera);
    document.getElementById('visionBtn').addEventListener('click', useNightVision);
    document.getElementById('restartBtn').addEventListener('click', restartGame);

    // Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
    window.addEventListener('keydown', (e)=>{
        keysPressed[e.key.toLowerCase()] = true;
        // Ø§Ø®ØªØµØ§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©
        if (e.key.toLowerCase() === 'q') useSmokeGrenade();
        if (e.key.toLowerCase() === 'h') hackCamera();
        if (e.key.toLowerCase() === 'n') useNightVision();
        if (e.key.toLowerCase() === 'r') restartGame();
    });
    window.addEventListener('keyup', (e)=>{ keysPressed[e.key.toLowerCase()] = false; });
}

/* ===== Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ø§ØµØ·Ø¯Ø§Ù… ===== */
function movePlayer(delta) {
    // Ù†Ø®Ø²Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ù‚Ø¨Ù„ Ø£ÙŠ Ø­Ø±ÙƒØ©
    lastPlayerPosition.copy(player.position);

    const speed = 3; // ÙˆØ­Ø¯Ø§Øª ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©
    const moveDistance = speed * delta;

    if (keysPressed['w']) player.position.z -= moveDistance;
    if (keysPressed['s']) player.position.z += moveDistance;
    if (keysPressed['a']) player.position.x -= moveDistance;
    if (keysPressed['d']) player.position.x += moveDistance;

    // Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±ÙƒØ©: ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØµØ·Ø¯Ø§Ù…Ø§ØªØ› Ø¥Ø°Ø§ Ø­Ø¯Ø«Øª Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø³Ø§Ø¨Ù‚
    if (checkWallCollision()) {
        player.position.copy(lastPlayerPosition);
    }

    // Ø­Ø¯Ù‘ Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¹Ù† Ø­Ø¯ÙˆØ¯ Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø´Ù‡Ø¯
    player.position.x = THREE.MathUtils.clamp(player.position.x, -24, 24);
    player.position.z = THREE.MathUtils.clamp(player.position.z, -24, 24);

    // Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ gameState
    gameState.playerPosition = { x: player.position.x, y: player.position.y, z: player.position.z };
}

/* ØªØ­Ù‚Ù‚ Ø§ØµØ·Ø¯Ø§Ù… Ø¨Ø§Ù„Ø¬Ø¯Ø±Ø§Ù† */
function checkWallCollision() {
    const playerBox = new THREE.Box3().setFromObject(player);
    for (const wall of walls) {
        const wallBox = new THREE.Box3().setFromObject(wall);
        if (playerBox.intersectsBox(wallBox)) return true;
    }
    return false;
}

/* ===== Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø±Ù‡Ø§Ø¦Ù† ÙˆØ§ØµØ·Ø¯Ø§Ù… Ø§Ù„Ø­Ø±Ø§Ø³ ===== */
function checkHostageAndGuardInteractions() {
    // Ø¥Ù†Ù‚Ø§Ø° Ø§Ù„Ø±Ù‡Ø§Ø¦Ù†
    for (const hostage of hostages) {
        if (!hostage.userData.rescued) {
            const distance = player.position.distanceTo(hostage.position);
            if (distance < 1.5) {
                hostage.userData.rescued = true;
                hostage.material.color.set(0x06d6a0);
                gameState.rescued++;
                updateUI();
                if (gameState.rescued === gameState.totalHostages) {
                    setTimeout(()=>{ alert('Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Ù‚Ø°Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ù‡Ø§Ø¦Ù†!'); nextLevel(); }, 400);
                }
            }
        }
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø±Ø§Ø³
    for (const guard of guards) {
        const distance = player.position.distanceTo(guard.position);
        if (distance < 1.5 && guard.userData.alert) {
            alert('Ù„Ù‚Ø¯ Ù‚Ø¨Ø¶ Ø¹Ù„ÙŠÙƒ Ø§Ù„Ø­Ø§Ø±Ø³! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            restartGame();
            break;
        }
    }
}

/* ===== ÙƒØ´Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª (Ù…Ø¹ Ù…Ø±Ø§Ø¹Ø§Ø© Ø­Ø§Ù„Ø© "blinded" Ù„Ù„Ø¯Ø®Ø§Ù†) ===== */
function checkCameraDetection() {
    let detected = false;

    for (const cameraObj of cameras) {
        if (cameraObj.userData.hacked || cameraObj.userData.blinded) {
            cameraObj.userData.active = false;
            cameraObj.material.color.set(0x666666);
            cameraObj.userData.light.color.set(0x666666);
            continue;
        }

        // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø±Ø¤ÙŠØ©: Ù†Ø³ØªØ®Ø¯Ù… Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ø¹Ø§Ù„Ù… Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const direction = new THREE.Vector3();
        cameraObj.getWorldDirection(direction); // Ø§ØªØ¬Ø§Ù‡ Ø¹Ø§Ù„Ù…Ù‰ Ù…Ù† Ø¬Ø³Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        const toPlayer = new THREE.Vector3().subVectors(player.position, cameraObj.position).normalize();
        const dotProduct = direction.dot(toPlayer);
        const distance = player.position.distanceTo(cameraObj.position);

        if (dotProduct > 0.78 && distance < 8) {
            // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹ÙˆØ§Ø¦Ù‚ (Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†)
            const raycaster = new THREE.Raycaster(cameraObj.position, toPlayer, 0.1, distance);
            const intersects = raycaster.intersectObjects(walls, true);
            if (intersects.length === 0) {
                cameraObj.userData.active = true;
                cameraObj.material.color.set(0xff4444);
                cameraObj.userData.light.color.set(0xff4444);
                detected = true;

                // ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­Ø±Ø§Ø³
                for (const guard of guards) {
                    guard.userData.alert = true;
                    guard.userData.target = player.position.clone();
                    guard.material.color.set(0xff0000);
                }
                continue;
            }
        }

        // Ø¥Ø°Ø§ Ù„Ù… ØªÙØ±Ù Ø§Ù„Ù„Ø§Ø¹Ø¨
        cameraObj.userData.active = false;
        if (!cameraObj.userData.hacked) cameraObj.material.color.set(0xff9800);
        cameraObj.userData.light.color.set(0xff9800);
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨
    if (detected && !gameState.cameraAlert) {
        gameState.cameraAlert = true;
        gameState.status = 'Ù…ÙƒØ´ÙˆÙ!';
        document.getElementById('cameraAlert').style.display = 'block';
    } else if (!detected && gameState.cameraAlert) {
        gameState.cameraAlert = false;
        gameState.status = 'Ø¢Ù…Ù†';
        document.getElementById('cameraAlert').style.display = 'none';
        // Ø¥Ù„ØºØ§Ø¡ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø­Ø±Ø§Ø³
        for (const guard of guards) {
            guard.userData.alert = false;
            guard.material.color.set(0xef476f);
        }
    }

    updateUI();
}

/* ===== Ù‚Ù†Ø¨Ù„Ø© Ø§Ù„Ø¯Ø®Ø§Ù†: ØªØ¤Ø«Ø± Ù…Ø¤Ù‚ØªØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª ===== */
function useSmokeGrenade() {
    if (gameState.abilities <= 0) return;
    gameState.abilities--;
    updateUI();

    // ØªØ£Ø«ÙŠØ± Ø¨ØµØ±ÙŠ Ø¨Ø³ÙŠØ·
    const smokeGeometry = new THREE.SphereGeometry(3, 12, 12);
    const smokeMaterial = new THREE.MeshBasicMaterial({ color:0x888888, transparent:true, opacity:0.6 });
    const smoke = new THREE.Mesh(smokeGeometry, smokeMaterial);
    smoke.position.copy(player.position);
    scene.add(smoke);

    // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒØ´Ù Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ù…Ø¤Ù‚ØªØ§
    for (const cam of cameras) {
        const d = cam.position.distanceTo(player.position);
        if (d < 8) cam.userData.blinded = true;
    }

    setTimeout(()=>{
        scene.remove(smoke);
        for (const cam of cameras) cam.userData.blinded = false;
    }, 4500);
}

/* ===== Ø§Ø®ØªØ±Ø§Ù‚ ÙƒØ§Ù…ÙŠØ±Ø§ ===== */
function hackCamera() {
    if (gameState.abilities <= 0) return;
    let hackedAny = false;
    for (const cam of cameras) {
        if (!cam.userData.hacked) {
            const distance = player.position.distanceTo(cam.position);
            if (distance < 5) {
                cam.userData.hacked = true;
                cam.userData.active = false;
                cam.material.color.set(0x666666);
                cam.userData.light.intensity = 0;
                hackedAny = true;
                gameState.abilities--;
                break;
            }
        }
    }
    if (hackedAny) updateUI();
}

/* ===== Ø±Ø¤ÙŠØ© Ù„ÙŠÙ„ÙŠØ© ===== */
function useNightVision() {
    if (gameState.abilities <= 0) return;
    gameState.abilities--;
    updateUI();

    const oldBg = scene.background.clone();
    const oldFogNear = scene.fog.near;
    const oldFogFar = scene.fog.far;

    scene.background = new THREE.Color(0x003300);
    scene.fog = new THREE.Fog(0x003300, 20, 100);

    setTimeout(()=>{
        scene.background = oldBg;
        scene.fog = new THREE.Fog(0x0c1426, oldFogNear, oldFogFar);
    }, 10000);
}

/* ===== ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø±Ø§Ø³ ===== */
function updateGuards(delta) {
    for (const guard of guards) {
        if (guard.userData.alert && guard.userData.target) {
            const dir = new THREE.Vector3().subVectors(guard.userData.target, guard.position).normalize();
            guard.position.add(dir.multiplyScalar(guard.userData.speed * delta * 60));
            guard.lookAt(guard.userData.target);
        } else {
            guard.rotation.y += 0.01 * delta * 60;
        }
    }
}

/* ===== ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª ===== */
function updateUI(){
    document.getElementById('level').textContent = gameState.level;
    document.getElementById('rescued').textContent = `${gameState.rescued}/${gameState.totalHostages}`;
    document.getElementById('status').textContent = gameState.status;
    document.getElementById('abilities').textContent = `${gameState.abilities}/${gameState.maxAbilities}`;
}

function nextLevel(){
    gameState.level++;
    gameState.rescued = 0;
    gameState.abilities = gameState.maxAbilities;
    player.position.set(0,0.5,0);
    lastPlayerPosition.copy(player.position);

    hostages.forEach(h => { h.userData.rescued = false; h.material.color.set(0x118ab2); });
    cameras.forEach(c => { c.userData.hacked = false; c.userData.active = false; c.material.color.set(0xff9800); c.userData.light.intensity = 2; });
    guards.forEach(g => { g.userData.alert = false; g.material.color.set(0xef476f); });

    updateUI();
}

function restartGame(){
    gameState.rescued = 0;
    gameState.abilities = gameState.maxAbilities;
    gameState.status = 'Ø¢Ù…Ù†';
    gameState.cameraAlert = false;

    player.position.set(0,0.5,0);
    lastPlayerPosition.copy(player.position);

    hostages.forEach(h => { h.userData.rescued = false; h.material.color.set(0x118ab2); });
    cameras.forEach(c => { c.userData.hacked = false; c.userData.active = false; c.material.color.set(0xff9800); c.userData.light.intensity = 2; c.userData.blinded = false; });
    guards.forEach(g => { g.userData.alert = false; g.material.color.set(0xef476f); });

    document.getElementById('cameraAlert').style.display = 'none';
    updateUI();
}

/* ===== ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© ===== */
function onWindowResize(){
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

/* ===== Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© ===== */
const clock = new THREE.Clock(false);
function animate(){
    requestAnimationFrame(animate);
    const delta = clock.getDelta();

    // Ø­Ø±ÙƒØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
    movePlayer(delta);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø±Ø§Ø³ ÙˆØ§Ù„ÙÙŠØ²ÙŠØ§Ø¡
    updateGuards(delta);
    checkHostageAndGuardInteractions();
    checkCameraDetection();

    controls.update();
    renderer.render(scene, camera);
}

/* ===== Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ===== */
init();
</script>
</body>
</html>
